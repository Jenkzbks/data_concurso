<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard de Empresas ‚Äî HTML Autosuficiente</title>
  <style>
    :root{ --bg:#ffffff; --card:#ffffff; --muted:#6b7280; --text:#111827; --accent:#1d4ed8; --grid:#e5e7eb }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter, ui-sans-serif, system-ui,-apple-system, Segoe UI, Roboto; background:var(--bg); color:var(--text)}
    header{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--grid)}
    .wrap{max-width:1200px; margin:0 auto; padding:16px}
    h1{font-size:22px; margin:8px 0 12px}
    h2{font-size:18px; margin:0 0 10px}
    .grid{display:grid; gap:16px}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    @media(max-width:1000px){.grid.cols-4{grid-template-columns:repeat(2,1fr)}.grid.cols-3{grid-template-columns:repeat(2,1fr)}.grid.cols-2{grid-template-columns:1fr}}
    @media(max-width:720px){.grid.cols-4,.grid.cols-3{grid-template-columns:1fr}}
    .card{background:var(--card); border:1px solid var(--grid); border-radius:16px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.06)}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .muted{color:var(--muted)}
    .btn,button{background:#f3f4f6; color:#111827; border:1px solid var(--grid); border-radius:10px; padding:8px 12px; cursor:pointer}
    .btn:hover,button:hover{background:#e5e7eb}
    input,select{background:#fff; color:#111827; border:1px solid var(--grid); border-radius:10px; padding:8px 10px}
    .kpi{display:flex; flex-direction:column; gap:4px; padding:14px; border:1px solid var(--grid); border-radius:12px; background:#fff}
    .kpi b{font-size:22px}
    .tabs{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap}
    .tab{padding:10px 14px; border-radius:10px; border:1px solid var(--grid); background:#fff; cursor:pointer}
    .tab.active{outline:2px solid var(--accent)}
    .view{display:none}
    .view.active{display:block}
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th,td{text-align:left; padding:10px 12px; vertical-align:top}
    thead th{font-size:12px; color:#374151; position:sticky; top:0; background:#fff}
    tbody tr{background:#fff; border:1px solid var(--grid)}
    tbody tr:hover{background:#f9fafb}
    tbody td:first-child, thead th:first-child{border-top-left-radius:8px; border-bottom-left-radius:8px}
    tbody td:last-child, thead th:last-child{border-top-right-radius:8px; border-bottom-right-radius:8px}
    .chart{width:100%; height:360px; display:block}
    .legend{display:flex; gap:10px; flex-wrap:wrap; font-size:12px; margin-top:8px}
    .legend .item{display:flex; gap:8px; align-items:center; cursor:pointer; padding:6px 8px; border-radius:8px}
    .legend .item:hover{background:#f8fafc}
    .legend .item .sw{width:12px; height:12px; border-radius:3px; display:inline-block}
    .legend .item.inactive{opacity:0.45}
    .legend.vertical{display:flex; flex-direction:column; gap:6px; align-items:flex-start}
    dialog{border:none; border-radius:16px; padding:0; width:min(680px, 92vw); background:#fff; color:#111827}
    .modal-head{padding:16px; border-bottom:1px solid var(--grid); display:flex; justify-content:space-between; align-items:center}
    .modal-body{padding:16px}
    .modal-grid{display:grid; grid-template-columns:180px 1fr; gap:8px}
    .close-x{background:transparent; border:none; color:#6b7280; font-size:20px; cursor:pointer}
    .heatmap{display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:10px}
    .heatcell{border:1px solid var(--grid); border-radius:10px; padding:10px; background:#fff}
    .bar{height:10px; border-radius:6px; background:linear-gradient(90deg, #e5f2ff, #1d4ed8)}
    .banner{background:#1d4ed8; color:#fff; padding:10px 16px; border-radius:12px; text-align:center; letter-spacing:.5px; font-weight:600}
    #tooltip{
      position:fixed; z-index:1000; pointer-events:none;
      background:#ffffff; color:#111827; border:1px solid #e5e7eb;
      border-radius:10px; padding:8px 10px; box-shadow:0 10px 24px rgba(0,0,0,.12);
      font-size:12px; line-height:1.3; transform:translate(-50%,-120%);
      opacity:0; transition:opacity .1s ease; white-space:nowrap;
    }
    #tooltip.show{opacity:1}
    #tooltip b{font-weight:600}
    .row-split{display:flex; gap:16px; align-items:flex-start}
    .row-split .side{width:240px; flex:0 0 240px}
    .row-split .main{flex:1}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1 style="flex:1">üìä Dashboard de Empresas</h1>
      <select id="filter-area"><option value="">Todas las √°reas</option></select>
      <select id="filter-tiponuevo"><option value="">Todos los tipos</option></select>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="banner">INFORMACI√ìN GENERAL DE PROYECTOS</div>
      <div style="height:12px"></div>
      <div class="grid cols-4">
        <div class="kpi"><span class="muted">Total registros</span><b id="kpi-total">0</b></div>
        <div class="kpi"><span class="muted">√Åreas</span><b id="kpi-areas">0</b></div>
        <div class="kpi"><span class="muted">Tipos de proyecto</span><b id="kpi-tipos">0</b></div>
        <div class="kpi"><span class="muted">Contactables (Tel / Mail)</span><b><span id="kpi-tel">0</span> / <span id="kpi-mail">0</span></b></div>
      </div>

      <div style="height:12px"></div>

      <div class="grid cols-2">
        <div class="card" style="padding:12px">
          <h2 style="margin-top:0">Por tipo de proyecto</h2>
          <svg id="chart-gen-tipo" class="chart" viewBox="0 0 800 360"></svg>
          <div id="legend-gen-tipo" class="legend"></div>
        </div>
        <div class="card" style="padding:12px">
          <h2 style="margin-top:0">Top departamentos</h2>
          <svg id="chart-gen-depa" class="chart" viewBox="0 0 800 360"></svg>
          <div id="legend-gen-depa" class="legend"></div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h2>Vistas</h2>
      <div class="row" style="margin-bottom:10px">
        <div class="tabs" role="tablist" style="flex:1">
          <button class="tab active" data-view="v-areadpto" role="tab">Distribuci√≥n por departamento</button>
          <button class="tab" data-view="v-heatmap" role="tab">Mapa de calor (Departamentos)</button>
          <button class="tab" data-view="v-tabla" role="tab">Tabla completa</button>
        </div>
      </div>

      <!-- Distribuci√≥n por Dpto (Agrupar por: √Årea / Tipo) -->
      <div class="view active" id="v-areadpto">
        <div class="row-split">
          <div class="main">
            <div class="row" style="margin-bottom:10px">
              <label class="muted">Departamento:</label>
              <select id="select-depa"></select>
              <span class="muted" style="margin-left:12px">Agrupar por:</span>
              <select id="group-by">
                <option value="por_area">√Årea</option>
                <option value="por_tipo_proyecto">Tipo</option>
              </select>
            </div>
            <svg id="chart-group-dpto" class="chart" viewBox="0 0 800 360"></svg>
          </div>
          <div class="side">
            <h3 style="margin:0 0 8px;font-size:14px" class="muted">Leyenda</h3>
            <div id="legend-group-dpto" class="legend vertical"></div>
          </div>
        </div>
      </div>

      <!-- Heatmap Departamentos -->
      <div class="view" id="v-heatmap">
        <div class="muted" style="margin-bottom:8px">Intensidad seg√∫n n√∫mero de registros por departamento</div>
        <div id="heatmap" class="heatmap"></div>
      </div>

      <!-- Tabla completa -->
      <div class="view" id="v-tabla">
        <div class="row" style="margin-bottom:10px">
            <input id="search" placeholder="Buscar (RUC, Raz√≥n, T√≠tulo, √Årea, Tipo‚Ä¶)" style="min-width:280px" />
            <select id="filter-depa" style="margin-left:8px"><option value="">Todos los departamentos</option></select>
        </div>
        <div style="overflow:auto; max-height:520px">
          <table id="table">
            <thead>
              <tr>
                <th>ID</th><th>RUC</th><th>Raz√≥n social</th><th>T√≠tulo</th><th>Tipo de proyecto</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <dialog id="modal">
    <div class="modal-head">
      <div>
        <div class="muted">RUC: <span id="m-ruc">‚Äî</span></div>
        <h2 id="m-razon">‚Äî</h2>
      </div>
      <button class="close-x" onclick="document.getElementById('modal').close()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-grid">
        <div class="muted">Lugar</div><div id="m-lugar"></div>
        <div class="muted">√Årea</div><div id="m-area"></div>
        <div class="muted">Tipo de proyecto</div><div id="m-tipo"></div>
        <div class="muted">Sector econ√≥mico</div><div id="m-sector"></div>
        <div class="muted">Actividad econ√≥mica</div><div id="m-actividad"></div>
        <div class="muted">Correo</div><div id="m-mail"></div>
        <div class="muted">Tel√©fono</div><div id="m-tel"></div>
      </div>
    </div>
  </dialog>

  <div id="tooltip"></div>
  <script id="csv-data" type="text/plain"></script>

  <script>
  const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>[...e.querySelectorAll(s)], fmt=n=>new Intl.NumberFormat('es-PE').format(n);
  const tip = $('#tooltip');
  function showTip(x,y, html){
    tip.innerHTML = html;
    const pad = 14;
    let tx = x + 16, ty = y - 10;
    const r = tip.getBoundingClientRect();
    if(tx + r.width + pad > innerWidth) tx = innerWidth - r.width - pad;
    if(ty + r.height + pad > innerHeight) ty = innerHeight - r.height - pad;
    if(ty < pad) ty = pad;
    tip.style.left = tx + 'px'; tip.style.top  = ty + 'px';
    tip.classList.add('show');
  }
  function hideTip(){ tip.classList.remove('show'); }

  function parseCSV(t,d=';'){
    const rows=[]; let cur='', row=[], inQ=false;
    for(let i=0;i<t.length;i++){
      const c=t[i], n=t[i+1];
      if(c==='"'){ if(inQ && n==='"'){ cur+='"'; i++; } else inQ=!inQ; }
      else if((c==='\n' || c==='\r') && !inQ){ if(!(cur==='' && row.length===0)) { row.push(cur); rows.push(row); } row=[]; cur=''; }
      else if(c===d && !inQ){ row.push(cur); cur=''; }
      else cur+=c;
    }
    if(cur.length||row.length){ row.push(cur); rows.push(row); }
    const headers = (rows.shift()||[]).map(h=>h.trim());
    return rows.filter(r=>r.some(v=>v&&v.trim())).map(r=>{ const o={}; headers.forEach((h,i)=>o[h]=(r[i]||'').trim()); return o; });
  }

  const uniq = a => [...new Set(a.filter(Boolean))];
  const groupCount = (data, key) => {
    const m = new Map();
    data.forEach(d=>{ const k=(d[key]||'‚Äî').toUpperCase(); m.set(k,(m.get(k)||0)+1); });
    return [...m.entries()].sort((a,b)=>b[1]-a[1]);
  };
  const pickColor = i => ['#2563eb','#16a34a','#f59e0b','#dc2626','#7e22ce','#db2777','#0891b2','#65a30d','#ea580c','#0ea5e9','#10b981','#a855f7'][i%12];

  function renderBarClassic(svg, pairs, {maxBars=10}={}){
    const W=800,H=360; svg.innerHTML='';
    const padTop=20, padBottom=30, padLeft=150, padRight=40, gap=8;
    const data=pairs.slice(0,maxBars);
    const maxV=Math.max(1, ...data.map(d=>d[1]));
    const barH=(H-padTop-padBottom-gap*(data.length-1))/Math.max(1,data.length);

    data.forEach(([label],i)=>{
      const y=padTop+i*(barH+gap)+barH/2+4;
      const t=document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x',padLeft-8); t.setAttribute('y',y);
      t.setAttribute('text-anchor','end'); t.textContent=label; svg.appendChild(t);
    });

    data.forEach(([label,val],i)=>{
      const y=padTop+i*(barH+gap), x=padLeft;
      const w=(W-padLeft-padRight)*(val/maxV), color=pickColor(i);
      const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x',x); rect.setAttribute('y',y); rect.setAttribute('width',w); rect.setAttribute('height',barH);
      rect.setAttribute('rx',6); rect.setAttribute('fill',color);
      const cls = 'series-'+label.replace(/[^a-z0-9]+/gi,'-').toLowerCase();
      rect.setAttribute('data-label', label);
      rect.classList.add(cls);
      rect.addEventListener('mousemove', e=>showTip(e.clientX,e.clientY, `<b>${label}</b>: ${fmt(val)}`));
      rect.addEventListener('mouseleave', hideTip);
      svg.appendChild(rect);

      const t=document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x',x+w+4); t.setAttribute('y',y+barH/2+4);
      t.textContent=fmt(val); svg.appendChild(t);
    });
  }

  function renderDonut(svg, pairs){
    const W=800,H=360,cx=W/2,cy=H/2,R=120,r=70; svg.innerHTML='';
    const total=Math.max(1,pairs.reduce((a,[,v])=>a+v,0));
    let ang0=-Math.PI/2;

    if(pairs.length===1){
      const [label,val]=pairs[0]; const color=pickColor(0);
      const ring=document.createElementNS('http://www.w3.org/2000/svg','circle');
      ring.setAttribute('cx',cx); ring.setAttribute('cy',cy); ring.setAttribute('r',(R+r)/2);
      ring.setAttribute('fill','none'); ring.setAttribute('stroke',color);
      ring.setAttribute('stroke-width', String(R-r));
      const cls = 'series-'+label.replace(/[^a-z0-9]+/gi,'-').toLowerCase();
      ring.setAttribute('data-label', label); ring.classList.add(cls);
      ring.addEventListener('mousemove', e=>showTip(e.clientX,e.clientY, `<b>${label}</b>: ${fmt(val)} registros`));
      ring.addEventListener('mouseleave', hideTip);
      svg.appendChild(ring); return;
    }

    pairs.forEach(([label,val],i)=>{
      const frac=val/total, ang1=ang0+frac*2*Math.PI, color=pickColor(i);
      const x0=cx+R*Math.cos(ang0), y0=cy+R*Math.sin(ang0), x1=cx+R*Math.cos(ang1), y1=cy+R*Math.sin(ang1);
      const large=(ang1-ang0)>Math.PI?1:0;

      const path=document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d',`M ${x0} ${y0} A ${R} ${R} 0 ${large} 1 ${x1} ${y1} L ${cx+r*Math.cos(ang1)} ${cy+r*Math.sin(ang1)} A ${r} ${r} 0 ${large} 0 ${cx+r*Math.cos(ang0)} ${cy+r*Math.sin(ang0)} Z`);
      path.setAttribute('fill',color);
      const cls = 'series-'+label.replace(/[^a-z0-9]+/gi,'-').toLowerCase();
      path.setAttribute('data-label', label); path.classList.add(cls);
      path.addEventListener('mousemove', e=>showTip(e.clientX,e.clientY, `<b>${label}</b><br>Total de empresas: ${fmt(val)}`));
      path.addEventListener('mouseleave', hideTip);
      svg.appendChild(path); ang0=ang1;
    });
  }

  const _legendStates = {};
  function renderLegend(el, pairs, opts={}){
    const chartId = opts.chartId || (el.id || 'legend');
    if(!_legendStates[chartId]) _legendStates[chartId] = new Set();
    const state = _legendStates[chartId];
    el.innerHTML = '';
    pairs.forEach(([k,v],i)=>{
      const label = k || '‚Äî';
      const key = label;
      const color = pickColor(i);
      const item = document.createElement('div'); item.className='item';
      if(state.size && !state.has(key)) item.classList.add('inactive');
      item.innerHTML = `<span class="sw" style="background:${color}"></span><span style="min-width:160px;display:inline-block">${label}</span><b>${fmt(v)}</b>`;
      item.addEventListener('mouseenter', ()=>{
        document.querySelectorAll('[class^="series-"]').forEach(n=>n.style.opacity='0.15');
        const cls = '.series-'+key.replace(/[^a-z0-9]+/gi,'-').toLowerCase();
        document.querySelectorAll(cls).forEach(n=>n.style.opacity='1');
      });
      item.addEventListener('mouseleave', ()=>{
        document.querySelectorAll('[class^="series-"]').forEach(n=>n.style.opacity='1');
      });
      item.addEventListener('click', ()=>{
        if(state.has(key)) state.delete(key); else state.add(key);
        Array.from(el.children).forEach(ch=>ch.classList.remove('inactive'));
        Array.from(el.children).forEach(ch=>{
          const txt = ch.textContent.trim();
          const lbl = txt.replace(/\s+\d+[.,\s]*$/,'');
          if(state.size && !state.has(lbl)) ch.classList.add('inactive');
        });
        if(typeof opts.onChange === 'function') opts.onChange();
      });
      el.appendChild(item);
    });
  }

  function renderHeatmap(el, counts){
    el.innerHTML=''; if(!counts.length){ el.textContent='Sin datos'; return; }
    const maxV = Math.max(...counts.map(c=>c[1]));
    counts.forEach(([dep,val])=>{
      const cell = document.createElement('div'); cell.className='heatcell';
      const title = document.createElement('div'); title.innerHTML = `<b>${dep}</b> <span class="muted">(${fmt(val)})</span>`; cell.appendChild(title);
      const barWrap = document.createElement('div'); barWrap.style.marginTop='8px'; barWrap.style.background='#eef2ff'; barWrap.style.borderRadius='6px'; barWrap.style.height='10px';
      const bar = document.createElement('div'); bar.className='bar'; bar.style.width = `${(val/maxV)*100}%`;
      const tipHtml = `<b>${dep}</b>: ${fmt(val)} registros`;
      cell.addEventListener('mousemove', e=>showTip(e.clientX,e.clientY, tipHtml));
      cell.addEventListener('mouseleave', hideTip);
      bar.addEventListener('mousemove', e=>showTip(e.clientX,e.clientY, tipHtml));
      bar.addEventListener('mouseleave', hideTip);
      barWrap.appendChild(bar); cell.appendChild(barWrap); el.appendChild(cell);
    });
  }

  let RAW=[], VIEW=[];
  function normalizeKeys(o){
    const keys=['id_empresas','razon_social','ruc','titulo','estado','direccion','departamento','provincia','distrito','actividad_economica','sector_economico','telefono','correo','por_area','por_tipo_proyecto'];
    const out={}; keys.forEach(k=> out[k]= o[k] ?? o[k?.toUpperCase?.()] ?? o[k?.toLowerCase?.()] ?? ''); return out;
  }

  function loadData(rows){
    RAW = rows.map(normalizeKeys); VIEW=[...RAW];

    const areas = [''].concat(uniq(RAW.map(d=>(d.por_area||'').toUpperCase())).sort());
    $('#filter-area').innerHTML = areas.map(v=>`<option value="${v}">${v||'Todas las √°reas'}</option>`).join('');

    const tipos = [''].concat(uniq(RAW.map(d=>(d.por_tipo_proyecto||'').toUpperCase())).sort());
    $('#filter-tiponuevo').innerHTML = tipos.map(v=>`<option value="${v}">${v||'Todos los tipos'}</option>`).join('');

    const deps = uniq(RAW.map(d=>(d.departamento||'').toUpperCase())).sort();
    $('#select-depa').innerHTML = [''].concat(deps).map(v=>`<option value="${v}">${v||'Todos los departamentos'}</option>`).join('');
    if($('#filter-depa')){
      $('#filter-depa').innerHTML = [''].concat(deps).map(v=>`<option value="${v}">${v||'Todos los departamentos'}</option>`).join('');
    }

    refreshAll();
  }

  function applyFilters(){
    const fa = $('#filter-area').value;
    const ft = $('#filter-tiponuevo').value;
    const fd = ($('#filter-depa') ? $('#filter-depa').value : '');

    VIEW = RAW.filter(d=>{
      const okA = !fa || (d.por_area||'').toUpperCase() === fa;
      const okT = !ft || (d.por_tipo_proyecto||'').toUpperCase() === ft;
      const okD = !fd || (d.departamento||'').toUpperCase() === fd;
      return okA && okT && okD;
    });
  }

  function updateKpis(){
    $('#kpi-total').textContent   = fmt(VIEW.length);
    $('#kpi-areas').textContent   = fmt(uniq(VIEW.map(d=>(d.por_area||'').toUpperCase())).length);
    $('#kpi-tipos').textContent   = fmt(uniq(VIEW.map(d=>(d.por_tipo_proyecto||'').toUpperCase())).length);
    $('#kpi-tel').textContent     = fmt(VIEW.filter(d=> (d.telefono||'').trim()).length);
    $('#kpi-mail').textContent    = fmt(VIEW.filter(d=> (d.correo||'').trim()).length);
  }

  function renderGeneral(){
    const tipoPairs = groupCount(VIEW,'por_tipo_proyecto');
    renderDonut($('#chart-gen-tipo'), tipoPairs);
    renderLegend($('#legend-gen-tipo'), tipoPairs, {chartId: 'gen-tipo', onChange: renderGeneral});

    const depa = groupCount(VIEW,'departamento').slice(0,10);
    renderBarClassic($('#chart-gen-depa'), depa, {maxBars:10});
    renderLegend($('#legend-gen-depa'), depa, {chartId: 'gen-depa', onChange: renderGeneral});
  }

  function renderTable(){
    const tb = $('#table tbody'); if(!tb) return; tb.innerHTML='';
    const q = ($('#search')?.value || '').trim().toLowerCase();

    const data = !q ? VIEW : VIEW.filter(d=>{
      return ['ruc','razon_social','titulo','por_area','por_tipo_proyecto','departamento','provincia','distrito']
        .some(k => (d[k]||'').toString().toLowerCase().includes(q));
    });

    data.forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${d.id_empresas||''}</td>
        <td>${d.ruc||''}</td>
        <td>${d.razon_social||''}</td>
        <td>${d.titulo||''}</td>
        <td>${d.por_tipo_proyecto||''}</td>`;
      tr.addEventListener('click',()=>openModal(d));
      tb.appendChild(tr);
    });
  }

  function renderViews(){
    renderGeneral();

    const depaCounts = groupCount(VIEW,'departamento');
    renderHeatmap($('#heatmap'), depaCounts);

    const selDep = $('#select-depa').value || '';
    const grpKey = $('#group-by').value || 'por_area'; // <-- toggle √Årea / Tipo
    const filtered = selDep ? VIEW.filter(d=> (d.departamento||'').toUpperCase()===selDep) : VIEW;
    const pairs = groupCount(filtered, grpKey);
    renderDonut($('#chart-group-dpto'), pairs);
    renderLegend($('#legend-group-dpto'), pairs, {chartId: 'group-dpto', onChange: renderViews});

    renderTable();
  }

  function refreshAll(){ applyFilters(); updateKpis(); renderViews(); }

  function openModal(d){
    const dep = (d.departamento||'').toString().trim();
    const pro = (d.provincia||'').toString().trim();
    const dis = (d.distrito||'').toString().trim();
    const lugar = [dep, pro, dis].filter(Boolean).join(' / ') || '‚Äî';
    $('#m-ruc').textContent   = d.ruc || '‚Äî';
    $('#m-razon').textContent = d.razon_social || '‚Äî';
    $('#m-lugar').textContent = lugar;
    $('#m-area').textContent  = d.por_area || '‚Äî';
    $('#m-tipo').textContent  = d.por_tipo_proyecto || '‚Äî';
    $('#m-sector').textContent = d.sector_economico || '‚Äî';
    $('#m-actividad').textContent = d.actividad_economica || '‚Äî';
    $('#m-mail').textContent  = d.correo || '‚Äî';
    $('#m-tel').textContent   = d.telefono || '‚Äî';
    document.getElementById('modal').showModal();
  }

  document.addEventListener('input', e=>{ if(e.target && (e.target.id==='search')) renderTable(); });
  $('#filter-area').addEventListener('change', refreshAll);
  $('#filter-tiponuevo').addEventListener('change', refreshAll);
  if($('#filter-depa')) $('#filter-depa').addEventListener('change', refreshAll);
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      $$('.view').forEach(v=>v.classList.remove('active')); document.getElementById(btn.dataset.view).classList.add('active');
    });
  });
  $('#select-depa').addEventListener('change', renderViews);
  $('#group-by').addEventListener('change', renderViews);

  async function loadPreferExternal(){
    const FILE_NAME = 'data_final.csv';
    try{
      const res = await fetch(FILE_NAME, {cache:'no-store'});
      if(!res.ok) throw new Error('No encontrado');
      const txt = await res.text();
      loadData(parseCSV(txt, ';'));
      console.info('CSV externo cargado:', FILE_NAME);
    }catch(e){
      console.warn('No se pudo leer', FILE_NAME, '-> uso CSV embebido');
      const fallback = document.getElementById('csv-data').textContent.trim();
      if(fallback){ loadData(parseCSV(fallback, ';')); }
      else{ alert('No se encontr√≥ '+FILE_NAME+' ni CSV embebido.'); }
    }
  }
  window.addEventListener('DOMContentLoaded', loadPreferExternal);
  </script>
</body>
</html>
