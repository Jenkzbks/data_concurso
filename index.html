<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard de Empresas — HTML Autosuficiente</title>
  <style>
    :root{ --bg:#ffffff; --card:#ffffff; --muted:#6b7280; --text:#111827; --accent:#1d4ed8; --grid:#e5e7eb }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter, ui-sans-serif, system-ui,-apple-system, Segoe UI, Roboto; background:var(--bg); color:var(--text)}
    header{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--grid)}
    .wrap{max-width:1200px; margin:0 auto; padding:16px}
    h1{font-size:22px; margin:8px 0 12px}
    h2{font-size:18px; margin:0 0 10px}
    .grid{display:grid; gap:16px}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    @media(max-width:1000px){.grid.cols-4{grid-template-columns:repeat(2,1fr)}.grid.cols-3{grid-template-columns:repeat(2,1fr)}.grid.cols-2{grid-template-columns:1fr}}
    @media(max-width:720px){.grid.cols-4,.grid.cols-3{grid-template-columns:1fr}}
    .card{background:var(--card); border:1px solid var(--grid); border-radius:16px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.06)}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .muted{color:var(--muted)}
    .btn,button{background:#f3f4f6; color:var(--text); border:1px solid var(--grid); border-radius:10px; padding:8px 12px; cursor:pointer}
    .btn:hover,button:hover{background:#e5e7eb}
    input,select{background:#fff; color:var(--text); border:1px solid var(--grid); border-radius:10px; padding:8px 10px}
    .kpi{display:flex; flex-direction:column; gap:4px; padding:14px; border:1px solid var(--grid); border-radius:12px; background:#fff}
    .kpi b{font-size:22px}
    .tabs{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap}
    .tab{padding:10px 14px; border-radius:10px; border:1px solid var(--grid); background:#fff; cursor:pointer}
    .tab.active{outline:2px solid var(--accent)}
    .view{display:none}
    .view.active{display:block}
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th,td{text-align:left; padding:10px 12px; vertical-align:top}
    thead th{font-size:12px; color:#374151; position:sticky; top:0; background:#fff}
    tbody tr{background:#fff; border:1px solid var(--grid)}
    tbody tr:hover{background:#f9fafb}
    tbody td:first-child, thead th:first-child{border-top-left-radius:8px; border-bottom-left-radius:8px}
    tbody td:last-child, thead th:last-child{border-top-right-radius:8px; border-bottom-right-radius:8px}
    .chart{width:100%; height:360px; display:block}
    .legend{display:flex; gap:10px; flex-wrap:wrap; font-size:12px; margin-top:8px}
    .legend.vertical{display:flex; flex-direction:column; gap:6px; align-items:flex-start}
    .dot{width:10px; height:10px; border-radius:2px; display:inline-block}
    dialog{border:none; border-radius:16px; padding:0; width:min(680px, 92vw); background:#fff; color:var(--text)}
    .modal-head{padding:16px; border-bottom:1px solid var(--grid); display:flex; justify-content:space-between; align-items:center}
    .modal-body{padding:16px}
    .modal-grid{display:grid; grid-template-columns:180px 1fr; gap:8px}
    .close-x{background:transparent; border:none; color:#6b7280; font-size:20px; cursor:pointer}
    /* Heatmap cards */
    .heatmap{display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:10px}
    .heatcell{border:1px solid var(--grid); border-radius:10px; padding:10px; background:#fff}
    .bar{height:10px; border-radius:6px; background:linear-gradient(90deg, #e5f2ff, #1d4ed8)}
    /* Banner */
    .banner{background:#1d4ed8; color:#fff; padding:10px 16px; border-radius:12px; text-align:center; letter-spacing:.5px; font-weight:600}
    /* Tooltip flotante */
    #tooltip{
      position:fixed; z-index:1000; pointer-events:none;
      background:#ffffff; color:#111827; border:1px solid #e5e7eb;
      border-radius:10px; padding:8px 10px; box-shadow:0 10px 24px rgba(0,0,0,.12);
      font-size:12px; line-height:1.3; transform:translate(-50%,-120%);
      opacity:0; transition:opacity .1s ease; white-space:nowrap;
    }
    #tooltip.show{opacity:1}
    #tooltip b{font-weight:600}
    /* Layout combo+gráfico+leyenda lateral */
    .row-split{display:flex; gap:16px; align-items:flex-start}
    .row-split .side{width:240px; flex:0 0 240px}
    .row-split .main{flex:1}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1 style="flex:1">📊 Dashboard de Empresas</h1>
      <!-- Filtros globales (dejamos aquí) -->
      <select id="filter-sector"><option value="">Todos los sectores</option></select>
      <select id="filter-tipo"><option value="">Todos los tipos</option></select>
    </div>
  </header>

  <main class="wrap">

    <!-- ============ INFORMACIÓN GENERAL (arriba) ============ -->
    <section class="card">
      <div class="banner">INFORMACIÓN GENERAL DE PROYECTOS</div>
      <div style="height:12px"></div>
      <div class="grid cols-4">
        <div class="kpi"><span class="muted">Total registros</span><b id="kpi-total">0</b></div>
        <div class="kpi"><span class="muted">Tipos de proyecto</span><b id="kpi-tipos">0</b></div>
        <div class="kpi"><span class="muted">Sectores económicos</span><b id="kpi-sectores">0</b></div>
        <div class="kpi">
          <span class="muted">Contactables (Tel / Mail)</span>
          <b><span id="kpi-tel">0</span> / <span id="kpi-mail">0</span></b>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="grid cols-2">
        <div class="card" style="padding:12px">
          <h2 style="margin-top:0">Por tipo de proyecto</h2>
          <svg id="chart-gen-tipo" class="chart" viewBox="0 0 800 360"></svg>
          <div id="legend-gen-tipo" class="legend"></div>
        </div>
        <div class="card" style="padding:12px">
          <h2 style="margin-top:0">Top departamentos</h2>
          <svg id="chart-gen-depa" class="chart" viewBox="0 0 800 360"></svg>
          <div id="legend-gen-depa" class="legend"></div>
        </div>
      </div>
    </section>

    <!-- ============ VISTAS ============ -->
    <section class="card" style="margin-top:16px">
      <h2>Vistas</h2>
      <div class="row" style="margin-bottom:10px">
        <div class="tabs" role="tablist" style="flex:1">
          <button class="tab active" data-view="v-sectordpto" role="tab">Sectores por departamento</button>
          <button class="tab" data-view="v-heatmap" role="tab">Mapa de calor (Departamentos)</button>
          <button class="tab" data-view="v-tabla" role="tab">Tabla completa</button>
        </div>
        
      </div>

      <!-- Sectores por Dpto (combo + donut + leyenda lateral) -->
      <div class="view active" id="v-sectordpto">
        <div class="row-split">
          <div class="main">
            <div class="row" style="margin-bottom:10px">
              <label class="muted">Departamento:</label>
              <select id="select-depa"></select>
            </div>
            <svg id="chart-sector-dpto" class="chart" viewBox="0 0 800 360"></svg>
          </div>
          <div class="side">
            <h3 style="margin:0 0 8px;font-size:14px" class="muted">Leyenda</h3>
            <div id="legend-sector-dpto" class="legend vertical"></div>
          </div>
        </div>
      </div>

      <!-- Heatmap Departamentos -->
      <div class="view" id="v-heatmap">
        <div class="muted" style="margin-bottom:8px">Intensidad según número de registros por departamento</div>
        <div id="heatmap" class="heatmap"></div>
      </div>

      <!-- Tabla completa -->
      <div class="view" id="v-tabla">
        <div class="row" style="margin-bottom:10px">
            <input id="search" placeholder="Buscar (RUC, Razón, Título, Sector…)" style="min-width:280px" />
            <select id="filter-depa" style="margin-left:8px"><option value="">Todos los departamentos</option></select>
        </div>
        <div style="overflow:auto; max-height:520px">
          <table id="table">
            <thead>
              <tr>
                <th>ID</th><th>RUC</th><th>Razón social</th><th>Título</th><th>Tipo de proyecto</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL -->
  <dialog id="modal">
    <div class="modal-head">
      <div>
        <div class="muted">RUC: <span id="m-ruc">—</span></div>
        <h2 id="m-razon">—</h2>
      </div>
      <button class="close-x" onclick="document.getElementById('modal').close()">✕</button>
    </div>
    <div class="modal-body">
      <div class="modal-grid">
        <div class="muted">Lugar</div><div id="m-lugar"></div>
        <div class="muted">Sector económico</div><div id="m-sector"></div>
        <div class="muted">Actividad económica</div><div id="m-actividad"></div>
        <div class="muted">Correo</div><div id="m-mail"></div>
        <div class="muted">Teléfono</div><div id="m-tel"></div>
      </div>
    </div>
  </dialog>

  <!-- Tooltip flotante -->
  <div id="tooltip"></div>

  <!-- CSV embebido opcional (fallback). Si no usarás hosting, pega aquí tu CSV -->
  <script id="csv-data" type="text/plain"></script>

  <script>
  // Helpers
  const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>[...e.querySelectorAll(s)], fmt=n=>new Intl.NumberFormat('es-PE').format(n);

  // Tooltip flotante
  const tip = $('#tooltip');
  function showTip(x,y, html){
    tip.innerHTML = html;
    const pad = 14;
    let tx = x + 16, ty = y - 10;
    const r = tip.getBoundingClientRect();
    if(tx + r.width + pad > innerWidth) tx = innerWidth - r.width - pad;
    if(ty + r.height + pad > innerHeight) ty = innerHeight - r.height - pad;
    if(ty < pad) ty = pad;
    tip.style.left = tx + 'px';
    tip.style.top  = ty + 'px';
    tip.classList.add('show');
  }
  function hideTip(){ tip.classList.remove('show'); }

  // CSV parser básico (delimitador ;)
  function parseCSV(t,d=';'){
    const rows=[]; let cur='', row=[], inQ=false;
    for(let i=0;i<t.length;i++){
      const c=t[i], n=t[i+1];
      if(c==='"'){ if(inQ && n==='"'){ cur+='"'; i++; } else inQ=!inQ; }
      else if((c==='\n' || c==='\r') && !inQ){ if(!(cur==='' && row.length===0)) { row.push(cur); rows.push(row); } row=[]; cur=''; }
      else if(c===d && !inQ){ row.push(cur); cur=''; }
      else cur+=c;
    }
    if(cur.length||row.length){ row.push(cur); rows.push(row); }
    const headers = (rows.shift()||[]).map(h=>h.trim());
    return rows.filter(r=>r.some(v=>v&&v.trim())).map(r=>{
      const o={}; headers.forEach((h,i)=>o[h]=(r[i]||'').trim()); return o;
    });
  }

  const uniq = a => [...new Set(a.filter(Boolean))];
  const groupCount = (data, key) => {
    const m = new Map();
    data.forEach(d=>{ const k=(d[key]||'—').toUpperCase(); m.set(k,(m.get(k)||0)+1); });
    return [...m.entries()].sort((a,b)=>b[1]-a[1]);
  };
  const pickColor = i => ['#2563eb','#16a34a','#f59e0b','#dc2626','#7e22ce','#db2777','#0891b2','#65a30d','#ea580c','#0ea5e9','#10b981','#a855f7'][i%12];

  // ---------- CHARTS ----------
  // 2) Barras horizontales clásicas (con eje de categorías a la izquierda)
  function renderBarClassic(svg, pairs, {maxBars=10}={}){
    const W=800,H=360; svg.innerHTML='';
    const padTop=20, padBottom=30, padLeft=150, padRight=40, gap=8;
    const data=pairs.slice(0,maxBars);
    const maxV=Math.max(1, ...data.map(d=>d[1]));
    const barH=(H-padTop-padBottom-gap*(data.length-1))/Math.max(1,data.length);

    // Eje Y (labels)
    data.forEach(([label,val],i)=>{
      const y=padTop+i*(barH+gap)+barH/2+4;
      const t=document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x',padLeft-8); t.setAttribute('y',y);
      t.setAttribute('text-anchor','end'); t.textContent=label; svg.appendChild(t);
    });

    // Barras
    data.forEach(([label,val],i)=>{
      const y=padTop+i*(barH+gap), x=padLeft;
      const w=(W-padLeft-padRight)*(val/maxV), color=pickColor(i);
      const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x',x); rect.setAttribute('y',y); rect.setAttribute('width',w); rect.setAttribute('height',barH);
      rect.setAttribute('rx',6); rect.setAttribute('fill',color);
      rect.addEventListener('mousemove', e=>showTip(e.clientX,e.clientY, `<b>${label}</b>: ${fmt(val)}`));
      rect.addEventListener('mouseleave', hideTip);
      svg.appendChild(rect);

      // valor al final
      const t=document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x',x+w+4); t.setAttribute('y',y+barH/2+4);
      t.textContent=fmt(val); svg.appendChild(t);
    });
  }

  // 1) Donut con caso especial 1 sola categoría => círculo completo
  function renderDonut(svg, pairs){
    const W=800,H=360,cx=W/2,cy=H/2,R=120,r=70; svg.innerHTML='';
    const total=Math.max(1,pairs.reduce((a,[,v])=>a+v,0));
    let ang0=-Math.PI/2;

    if(pairs.length===1){
      const [label,val]=pairs[0]; const color=pickColor(0);
      // Círculo completo con stroke (anillo)
      const ring=document.createElementNS('http://www.w3.org/2000/svg','circle');
      ring.setAttribute('cx',cx); ring.setAttribute('cy',cy); ring.setAttribute('r',(R+r)/2);
      ring.setAttribute('fill','none'); ring.setAttribute('stroke',color);
      ring.setAttribute('stroke-width', String(R-r));
      ring.addEventListener('mousemove', e=>showTip(e.clientX,e.clientY, `<b>${label}</b>: ${fmt(val)} registros`));
      ring.addEventListener('mouseleave', hideTip);
      svg.appendChild(ring);
      return;
    }

    pairs.forEach(([label,val],i)=>{
      const frac=val/total, ang1=ang0+frac*2*Math.PI, color=pickColor(i);
      const x0=cx+R*Math.cos(ang0), y0=cy+R*Math.sin(ang0), x1=cx+R*Math.cos(ang1), y1=cy+R*Math.sin(ang1);
      const large=(ang1-ang0)>Math.PI?1:0;

      const path=document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d',`M ${x0} ${y0} A ${R} ${R} 0 ${large} 1 ${x1} ${y1} L ${cx+r*Math.cos(ang1)} ${cy+r*Math.sin(ang1)} A ${r} ${r} 0 ${large} 0 ${cx+r*Math.cos(ang0)} ${cy+r*Math.sin(ang0)} Z`);
      path.setAttribute('fill',color);
      path.addEventListener('mousemove', e=>showTip(e.clientX,e.clientY, `<b>${label}</b><br>Total de empresas: ${fmt(val)}`));
      path.addEventListener('mouseleave', hideTip);
      svg.appendChild(path);
      ang0=ang1;
    });
  }

  // Leyendas
  function renderLegend(el, pairs){
    el.innerHTML = pairs.map(([k,v],i)=>`<span><i class="dot" style="background:${pickColor(i)}"></i>${k} <b>${fmt(v)}</b></span>`).join('');
  }

  // Heatmap cards + tooltip
  function renderHeatmap(el, counts){
    el.innerHTML=''; if(!counts.length){ el.textContent='Sin datos'; return; }
    const maxV = Math.max(...counts.map(c=>c[1]));
    counts.forEach(([dep,val])=>{
      const cell = document.createElement('div'); cell.className='heatcell';
      const title = document.createElement('div'); title.innerHTML = `<b>${dep}</b> <span class="muted">(${fmt(val)})</span>`; cell.appendChild(title);
      const barWrap = document.createElement('div'); barWrap.style.marginTop='8px'; barWrap.style.background='#eef2ff'; barWrap.style.borderRadius='6px'; barWrap.style.height='10px';
      const bar = document.createElement('div'); bar.className='bar'; bar.style.width = `${(val/maxV)*100}%`;
      const tipHtml = `<b>${dep}</b>: ${fmt(val)} registros`;
      cell.addEventListener('mousemove', e=>showTip(e.clientX,e.clientY, tipHtml));
      cell.addEventListener('mouseleave', hideTip);
      bar.addEventListener('mousemove', e=>showTip(e.clientX,e.clientY, tipHtml));
      bar.addEventListener('mouseleave', hideTip);
      barWrap.appendChild(bar); cell.appendChild(barWrap); el.appendChild(cell);
    });
  }

  // ---------- DATA + UI ----------
  let RAW=[], VIEW=[];
  function normalizeKeys(o){
    const keys=['id_empresas','razon_social','ruc','titulo','tipo_proyecto','estado','direccion','departamento','provincia','distrito','actividad_economica','sector_economico','telefono','correo'];
    const out={}; keys.forEach(k=> out[k]= o[k] ?? o[k?.toUpperCase?.()] ?? o[k?.toLowerCase?.()] ?? ''); return out;
  }
  function loadData(rows){
    RAW = rows.map(normalizeKeys); VIEW=[...RAW];
    // filtros globales
    $('#filter-sector').innerHTML = [''].concat(uniq(RAW.map(d=>(d.sector_economico||'').toUpperCase())).sort()).map(v=>`<option value="${v}">${v||'Todos los sectores'}</option>`).join('');
    $('#filter-tipo').innerHTML   = [''].concat(uniq(RAW.map(d=>(d.tipo_proyecto||'').toUpperCase())).sort()).map(v=>`<option value="${v}">${v||'Todos los tipos'}</option>`).join('');
    // select depa
  const deps = uniq(RAW.map(d=>(d.departamento||'').toUpperCase())).sort();
  // Añadir opción por defecto para mostrar "Todos los departamentos"
  $('#select-depa').innerHTML = [''].concat(deps).map(v=>`<option value="${v}">${v||'Todos los departamentos'}</option>`).join('');
    // poblar filtro de departamento para la tabla completa
    if($('#filter-depa')){
      $('#filter-depa').innerHTML = [''].concat(deps).map(v=>`<option value="${v}">${v||'Todos los departamentos'}</option>`).join('');
    }
    refreshAll();
  }

  function applyFilters(){
    const fs = $('#filter-sector').value;
    const ft = $('#filter-tipo').value;
    const fd = ($('#filter-depa') ? $('#filter-depa').value : '');
    // VIEW se usa para KPIs y gráficos; NO incluye búsqueda
  VIEW = RAW.filter(d=>{
    const okS = !fs || (d.sector_economico||'').toUpperCase() === fs;
    const okT = !ft || (d.tipo_proyecto||'').toUpperCase() === ft;
    const okD = !fd || (d.departamento||'').toUpperCase() === fd;
    return okS && okT && okD;
  });
  }
  function updateKpis(){
    $('#kpi-total').textContent = fmt(VIEW.length);
    $('#kpi-tipos').textContent = fmt(uniq(VIEW.map(d=>(d.tipo_proyecto||'').toUpperCase())).length);
    $('#kpi-sectores').textContent = fmt(uniq(VIEW.map(d=>(d.sector_economico||'').toUpperCase())).length);
    $('#kpi-tel').textContent = fmt(VIEW.filter(d=> (d.telefono||'').trim()).length);
    $('#kpi-mail').textContent = fmt(VIEW.filter(d=> (d.correo||'').trim()).length);
  }

  // General (arriba)
  function renderGeneral(){
    const tipo = groupCount(VIEW,'tipo_proyecto');
    renderDonut($('#chart-gen-tipo'), tipo);
    renderLegend($('#legend-gen-tipo'), tipo);

    const depa = groupCount(VIEW,'departamento').slice(0,10);
    renderBarClassic($('#chart-gen-depa'), depa, {maxBars:10});
    $('#legend-gen-depa').innerHTML = depa.map(([k,v],i)=>`<span><i class="dot" style="background:${pickColor(i)}"></i>${k} <b>${fmt(v)}</b></span>`).join('');
  }

  function renderTable(){
  const tb = $('#table tbody'); if(!tb) return; tb.innerHTML='';
  const q = ($('#search')?.value || '').trim().toLowerCase();

  // Partimos de VIEW (ya filtrado por sector/tipo) y aquí aplicamos búsqueda
  const data = !q ? VIEW : VIEW.filter(d=>{
    return ['ruc','razon_social','titulo','sector_economico','tipo_proyecto','departamento','provincia','distrito']
      .some(k => (d[k]||'').toString().toLowerCase().includes(q));
  });

  data.forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${d.id_empresas||''}</td>
      <td>${d.ruc||''}</td>
      <td>${d.razon_social||''}</td>
      <td>${d.titulo||''}</td>
      <td>${d.tipo_proyecto||''}</td>`;
    tr.addEventListener('click',()=>openModal(d));
    tb.appendChild(tr);
  });
}

  function renderViews(){
    // GENERAL
    renderGeneral();

    // Heatmap
    const depaCounts = groupCount(VIEW,'departamento');
    renderHeatmap($('#heatmap'), depaCounts);

    // Donut sectores por dpto (tooltip “Total de empresas” y leyenda al costado)
  // Si el usuario no ha elegido departamento (valor ''), mostramos los datos agregados de todos
  const sel = $('#select-depa').value || '';
  // filtered será VIEW (todos) cuando sel === ''
  const filtered = sel ? VIEW.filter(d=> (d.departamento||'').toUpperCase()===sel) : VIEW;
    const sectorPairs = groupCount(filtered,'sector_economico');
    renderDonut($('#chart-sector-dpto'), sectorPairs);
    renderLegend($('#legend-sector-dpto'), sectorPairs);

    // Tabla
    renderTable();
  }

  function refreshAll(){ applyFilters(); updateKpis(); renderViews(); }

  function openModal(d){
    const dep = (d.departamento||'').toString().trim();
    const pro = (d.provincia||'').toString().trim();
    const dis = (d.distrito||'').toString().trim();
    const lugar = [dep, pro, dis].filter(Boolean).join(' / ') || '—';
    $('#m-ruc').textContent = d.ruc || '—';
    $('#m-razon').textContent = d.razon_social || '—';
    $('#m-lugar').textContent = lugar;
    $('#m-sector').textContent = d.sector_economico || '—';
    $('#m-actividad').textContent = d.actividad_economica || '—';
    $('#m-mail').textContent = d.correo || '—';
    $('#m-tel').textContent = d.telefono || '—';
    document.getElementById('modal').showModal();
  }

  // Eventos
  document.addEventListener('input', e=>{
    if(e.target && (e.target.id==='search')) refreshAll();
  });
  $('#filter-sector').addEventListener('change', refreshAll);
  $('#filter-tipo').addEventListener('change', refreshAll);
  if($('#filter-depa')) $('#filter-depa').addEventListener('change', refreshAll);
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      $$('.view').forEach(v=>v.classList.remove('active')); document.getElementById(btn.dataset.view).classList.add('active');
    });
  });
  $('#select-depa').addEventListener('change', renderViews);

  // ===== CARGA AUTOMÁTICA =====
  async function loadPreferExternal(){
    const FILE_NAME = 'data_final.utf8.csv'; // mismo directorio que este HTML
    try{
      const res = await fetch(FILE_NAME, {cache:'no-store'});
      if(!res.ok) throw new Error('No encontrado');
      const txt = await res.text();
      loadData(parseCSV(txt, ';'));
      console.info('CSV externo cargado:', FILE_NAME);
    }catch(e){
      console.warn('No se pudo leer', FILE_NAME, '-> uso CSV embebido');
      const fallback = document.getElementById('csv-data').textContent.trim();
      if(fallback){ loadData(parseCSV(fallback, ';')); }
      else{ alert('No se encontró '+FILE_NAME+' ni CSV embebido.'); }
    }
  }
  window.addEventListener('DOMContentLoaded', loadPreferExternal);
  </script>
</body>
</html>
