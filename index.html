<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard de Empresas ‚Äî HTML Autosuficiente</title>
  <style>
    :root{ --bg:#ffffff; --card:#ffffff; --muted:#6b7280; --text:#111827; --accent:#1d4ed8; --grid:#e5e7eb }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter, ui-sans-serif, system-ui,-apple-system, Segoe UI, Roboto; background:var(--bg); color:var(--text)}
    header{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--grid)}
    .wrap{max-width:1200px; margin:0 auto; padding:16px}
    h1{font-size:22px; margin:8px 0 12px}
    h2{font-size:18px; margin:0 0 10px}
    .grid{display:grid; gap:16px}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    @media(max-width:1000px){.grid.cols-4{grid-template-columns:repeat(2,1fr)}.grid.cols-3{grid-template-columns:repeat(2,1fr)}.grid.cols-2{grid-template-columns:1fr}}
    @media(max-width:720px){.grid.cols-4,.grid.cols-3{grid-template-columns:1fr}}
    .card{background:var(--card); border:1px solid var(--grid); border-radius:16px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.06)}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .muted{color:var(--muted)}
    .btn,button{background:#f3f4f6; color:#111827; border:1px solid var(--grid); border-radius:10px; padding:8px 12px; cursor:pointer}
    .btn:hover,button:hover{background:#e5e7eb}
    input,select{background:#fff; color:#111827; border:1px solid var(--grid); border-radius:10px; padding:8px 10px}
    .kpi{display:flex; flex-direction:column; gap:4px; padding:14px; border:1px solid var(--grid); border-radius:12px; background:#fff}
    .kpi b{font-size:22px}
    .tabs{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap}
    .tab{padding:10px 14px; border-radius:10px; border:1px solid var(--grid); background:#fff; cursor:pointer}
    .tab.active{outline:2px solid var(--accent)}
    .toggle{display:inline-flex; border:1px solid var(--grid); border-radius:12px; overflow:hidden}
    .toggle button{padding:8px 12px; border:none; background:#fff; cursor:pointer}
    .toggle button.active{background:#1d4ed8; color:#fff}
    .view{display:none}
    .view.active{display:block}
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th,td{text-align:left; padding:10px 12px; vertical-align:top}
    thead th{font-size:12px; color:#374151; position:sticky; top:0; background:#fff}
    tbody tr{background:#fff; border:1px solid var(--grid)}
    tbody tr:hover{background:#f9fafb}
    tbody td:first-child, thead th:first-child{border-top-left-radius:8px; border-bottom-left-radius:8px}
    tbody td:last-child, thead th:last-child{border-top-right-radius:8px; border-bottom-right-radius:8px}
    .chart{width:100%; height:360px; display:block}
    .legend{display:flex; gap:10px; flex-wrap:wrap; font-size:12px; margin-top:8px}
    .legend .item{display:flex; gap:8px; align-items:center; cursor:pointer; padding:6px 8px; border-radius:8px}
    .legend .item:hover{background:#f8fafc}
    .legend .item .sw{width:12px; height:12px; border-radius:3px; display:inline-block}
    .legend .item.inactive{opacity:0.45}
    .legend.vertical{display:flex; flex-direction:column; gap:6px; align-items:flex-start}
    dialog{border:none; border-radius:16px; padding:0; width:min(680px, 92vw); background:#fff; color:#111827}
    .modal-head{padding:16px; border-bottom:1px solid var(--grid); display:flex; justify-content:space-between; align-items:center}
    .modal-body{padding:16px}
    .modal-grid{display:grid; grid-template-columns:180px 1fr; gap:8px}
    .close-x{background:transparent; border:none; color:#6b7280; font-size:20px; cursor:pointer}
    .heatmap{display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:10px}
    .heatcell{border:1px solid var(--grid); border-radius:10px; padding:10px; background:#fff}
    .bar{height:10px; border-radius:6px; background:linear-gradient(90deg, #e5f2ff, #1d4ed8)}
    .banner{background:#1d4ed8; color:#fff; padding:10px 16px; border-radius:12px; text-align:center; letter-spacing:.5px; font-weight:600}
    #tooltip{position:fixed; z-index:1000; pointer-events:none; background:#ffffff; color:#111827; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; box-shadow:0 10px 24px rgba(0,0,0,.12); font-size:12px; line-height:1.3; transform:translate(-50%,-120%); opacity:0; transition:opacity .1s ease; white-space:nowrap}
    #tooltip.show{opacity:1}
    #tooltip b{font-weight:600}
    .row-split{display:flex; gap:16px; align-items:flex-start}
    .row-split .side{width:240px; flex:0 0 240px}
    .row-split .main{flex:1}
    .hint{font-size:12px;color:#6b7280}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1 style="flex:1">üìä Dashboard de Empresas</h1>
      <!-- filtros globales (Final por defecto) -->
      <select id="filter-area"><option value="">Todas las √°reas</option></select>
      <select id="filter-tiponuevo"><option value="">Todos los tipos</option></select>
    </div>
  </header>

  <main class="wrap">
    <!-- ===== INFO GENERAL ===== -->
    <section class="card">
      <div class="banner">INFORMACI√ìN GENERAL DE PROYECTOS</div>
      <div style="height:12px"></div>
      <div class="grid cols-4">
        <div class="kpi"><span class="muted">Total registros</span><b id="kpi-total">0</b></div>
        <div class="kpi"><span class="muted">√Åreas (Final)</span><b id="kpi-areas">0</b></div>
        <div class="kpi"><span class="muted">Tipos (Final)</span><b id="kpi-tipos">0</b></div>
        <div class="kpi"><span class="muted">Contactables (Tel / Mail)</span><b><span id="kpi-tel">0</span> / <span id="kpi-mail">0</span></b></div>
      </div>
      <div class="grid cols-3" style="margin-top:12px">
        <div class="kpi"><span class="muted">√Åreas detectadas √∫nicas</span><b id="kpi-areas-det">0</b></div>
        <div class="kpi"><span class="muted">Tipos detectados √∫nicos</span><b id="kpi-tipos-det">0</b></div>
        <div class="kpi"><span class="muted">Modo</span><b><span id="kpi-modo">Final</span></b></div>
      </div>

      <div style="height:12px"></div>

      <!-- Controles de Fuente y M√©todo -->
      <div class="row" style="gap:16px; align-items:center">
        <div>
          <div class="muted" style="margin-bottom:6px">Fuente de categorizaci√≥n</div>
          <div class="toggle" id="toggle-source">
            <button data-src="final" class="active">Final</button>
            <button data-src="detectadas">Detectadas</button>
          </div>
        </div>
        <div id="wrap-weight" style="display:none">
          <div class="muted" style="margin-bottom:6px">M√©todo de conteo (modo Detectadas)</div>
          <div class="toggle" id="toggle-weight">
            <button data-w="bruto" class="active">Bruto</button>
            <button data-w="ponderado">Ponderado 1/n</button>
          </div>
        </div>
        <div class="hint">Los gr√°ficos de abajo cambian seg√∫n la <b>fuente</b> y el <b>m√©todo</b>.</div>
      </div>

      <div style="height:12px"></div>

      <div class="grid cols-2">
        <div class="card" style="padding:12px">
          <h2 style="margin-top:0">Distribuci√≥n principal</h2>
          <div class="hint" id="hint-main">Usando <b>TIPO_FINAL</b></div>
          <svg id="chart-gen-tipo" class="chart" viewBox="0 0 800 360"></svg>
          <div id="legend-gen-tipo" class="legend"></div>
        </div>
        <div class="card" style="padding:12px">
          <h2 style="margin-top:0">Top departamentos</h2>
          <svg id="chart-gen-depa" class="chart" viewBox="0 0 800 360"></svg>
          <div id="legend-gen-depa" class="legend"></div>
        </div>
      </div>
    </section>

    <!-- ===== VISTAS ===== -->
    <section class="card" style="margin-top:16px">
      <h2>Vistas</h2>
      <div class="row" style="margin-bottom:10px">
        <div class="tabs" role="tablist" style="flex:1">
          <button class="tab active" data-view="v-areadpto" role="tab">Distribuci√≥n por departamento</button>
          <button class="tab" data-view="v-heatmap" role="tab">Mapa de calor (Departamentos)</button>
          <button class="tab" data-view="v-tabla" role="tab">Tabla completa</button>
        </div>
      </div>

      <!-- Distribuci√≥n por Dpto -->
      <div class="view active" id="v-areadpto">
        <div class="row-split">
          <div class="main">
            <div class="row" style="margin-bottom:10px">
              <label class="muted">Departamento:</label>
              <select id="select-depa"></select>
              <span class="muted" style="margin-left:12px">Agrupar por:</span>
              <select id="group-by">
                <option value="area_final">√Årea (Final)</option>
                <option value="tipo_final">Tipo (Final)</option>
                <option value="areas_detectadas">√Åreas (Detectadas)</option>
                <option value="tipos_detectados">Tipos (Detectados)</option>
              </select>
            </div>
            <div class="hint" id="hint-dpto">Usando <b>√ÅREA_FINAL</b></div>
            <svg id="chart-group-dpto" class="chart" viewBox="0 0 800 360"></svg>
          </div>
          <div class="side">
            <h3 style="margin:0 0 8px;font-size:14px" class="muted">Leyenda</h3>
            <div id="legend-group-dpto" class="legend vertical"></div>
          </div>
        </div>
      </div>

      <!-- Heatmap Departamentos -->
      <div class="view" id="v-heatmap">
        <div class="muted" style="margin-bottom:8px">Intensidad seg√∫n n√∫mero de registros por departamento</div>
        <div id="heatmap" class="heatmap"></div>
      </div>

      <!-- Tabla completa -->
      <div class="view" id="v-tabla">
        <div class="row" style="margin-bottom:10px">
            <input id="search" placeholder="Buscar (RUC, Raz√≥n, T√≠tulo, √Årea, Tipo‚Ä¶)" style="min-width:280px" />
            <select id="filter-depa" style="margin-left:8px"><option value="">Todos los departamentos</option></select>
        </div>
        <div style="overflow:auto; max-height:520px">
          <table id="table">
            <thead>
              <tr>
                <th>ID</th><th>RUC</th><th>Raz√≥n social</th><th>T√≠tulo</th><th>Tipo de proyecto</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== MODAL ===== -->
  <dialog id="modal">
    <div class="modal-head">
      <div>
        <div class="muted">RUC: <span id="m-ruc">‚Äî</span></div>
        <h2 id="m-razon">‚Äî</h2>
      </div>
      <button class="close-x" onclick="document.getElementById('modal').close()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-grid">
        <div class="muted">Lugar</div><div id="m-lugar"></div>
        <div class="muted">√Årea</div><div id="m-area"></div>
        <div class="muted">Tipo de proyecto</div><div id="m-tipo"></div>
        <div class="muted">Sector econ√≥mico</div><div id="m-sector"></div>
        <div class="muted">Actividad econ√≥mica</div><div id="m-actividad"></div>
        <div class="muted">Correo</div><div id="m-mail"></div>
        <div class="muted">Tel√©fono</div><div id="m-tel"></div>

        <!-- Trazabilidad si existen -->
        <div class="muted">√Åreas detectadas</div><div id="m-areas-det"></div>
        <div class="muted">Tipos detectados</div><div id="m-tipos-det"></div>
      </div>
    </div>
  </dialog>

  <div id="tooltip"></div>
  <script id="csv-data" type="text/plain"></script>

  <script>
  // ------------- Helpers & Tooltip -------------
  const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>[...e.querySelectorAll(s)], fmt=n=>new Intl.NumberFormat('es-PE').format(n);
  const tip = $('#tooltip');
  function showTip(x,y, html){
    tip.innerHTML = html;
    const pad = 14; let tx = x + 16, ty = y - 10;
    const r = tip.getBoundingClientRect();
    if(tx + r.width + pad > innerWidth) tx = innerWidth - r.width - pad;
    if(ty + r.height + pad > innerHeight) ty = innerHeight - r.height - pad;
    if(ty < pad) ty = pad;
    tip.style.left = tx + 'px'; tip.style.top  = ty + 'px';
    tip.classList.add('show');
  }
  function hideTip(){ tip.classList.remove('show'); }

  // ------------- CSV Parser -------------
  function parseCSV(t,d=';'){
    const rows=[]; let cur='', row=[], inQ=false;
    for(let i=0;i<t.length;i++){
      const c=t[i], n=t[i+1];
      if(c==='"'){ if(inQ && n==='"'){ cur+='"'; i++; } else inQ=!inQ; }
      else if((c==='\n' || c==='\r') && !inQ){ if(!(cur==='' && row.length===0)) { row.push(cur); rows.push(row); } row=[]; cur=''; }
      else if(c===d && !inQ){ row.push(cur); cur=''; }
      else cur+=c;
    }
    if(cur.length||row.length){ row.push(cur); rows.push(row); }
    const headers = (rows.shift()||[]).map(h=>h.trim());
    return rows.filter(r=>r.some(v=>v&&v.trim())).map(r=>{ const o={}; headers.forEach((h,i)=>o[h]=(r[i]||'').trim()); return o; });
  }

  // ------------- Utils -------------
  const uniq = a => [...new Set(a.filter(Boolean))];
  const pickColor = i => ['#2563eb','#16a34a','#f59e0b','#dc2626','#7e22ce','#db2777','#0891b2','#65a30d','#ea580c','#0ea5e9','#10b981','#a855f7'][i%12];

  // Normalizador de listas DETECTADAS: "ERP(3), CRM(1)" -> ["ERP","CRM"]
  function parseDetected(str){
    if(!str) return [];
    return str
      .split(/[,;|]/)
      .map(s => s.replace(/\(\d+\)/g,'').trim().toUpperCase())
      .filter(Boolean);
  }

  // Conteo por pares [label, valor] para FINAL
  function groupCountFinal(rows, key){
    const m = new Map();
    rows.forEach(d=>{
      const k=(d[key]||'‚Äî').toUpperCase();
      m.set(k,(m.get(k)||0)+1);
    });
    return [...m.entries()].sort((a,b)=>b[1]-a[1]);
  }

  // Conteo para DETECTADAS (bruto o ponderado)
  function countDetected(rows, col, {weighted=false}={}){
    const m = new Map();
    for(const d of rows){
      const arr = parseDetected(d[col]);
      if(arr.length===0) continue;
      const w = weighted ? 1/arr.length : 1;
      for(const k of arr){
        m.set(k, (m.get(k)||0) + w);
      }
    }
    // ordenar por valor desc
    return [...m.entries()].sort((a,b)=>b[1]-a[1]);
  }

  // ------------- Charts (SVG) -------------
  function renderBarClassic(svg, pairs, {maxBars=10}={}){
    const W=800,H=360; svg.innerHTML='';
    const padTop=20, padBottom=30, padLeft=150, padRight=40, gap=8;
    const data=pairs.slice(0,maxBars);
    const maxV=Math.max(1, ...data.map(d=>d[1]));
    const barH=(H-padTop-padBottom-gap*(data.length-1))/Math.max(1,data.length);
    data.forEach(([label],i)=>{
      const y=padTop+i*(barH+gap)+barH/2+4;
      const t=document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x',padLeft-8); t.setAttribute('y',y);
      t.setAttribute('text-anchor','end'); t.textContent=label; svg.appendChild(t);
    });
    data.forEach(([label,val],i)=>{
      const y=padTop+i*(barH+gap), x=padLeft;
      const w=(W-padLeft-padRight)*(val/maxV), color=pickColor(i);
      const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x',x); rect.setAttribute('y',y); rect.setAttribute('width',w); rect.setAttribute('height',barH);
      rect.setAttribute('rx',6); rect.setAttribute('fill',color);
      const cls = 'series-'+label.replace(/[^a-z0-9]+/gi,'-').toLowerCase();
      rect.setAttribute('data-label', label);
      rect.classList.add(cls);
      rect.addEventListener('mousemove', e=>showTip(e.clientX,e.clientY, `<b>${label}</b>: ${fmt(val)}`));
      rect.addEventListener('mouseleave', hideTip);
      svg.appendChild(rect);
      const t=document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x',x+w+4); t.setAttribute('y',y+barH/2+4);
      t.textContent=fmt(Math.round(val*100)/100); svg.appendChild(t);
    });
  }

  function renderDonut(svg, pairs, {source='final', method='bruto'}={}){
    const W=800,H=360,cx=W/2,cy=H/2,R=120,r=70; svg.innerHTML='';
    const total=pairs.reduce((a,[,v])=>a+v,0);
    const pretty = v => (method==='ponderado' ? Math.round(v*100)/100 : v);
    let ang0=-Math.PI/2;

    if(pairs.length===1){
      const [label,val]=pairs[0]; const color=pickColor(0);
      const ring=document.createElementNS('http://www.w3.org/2000/svg','circle');
      ring.setAttribute('cx',cx); ring.setAttribute('cy',cy); ring.setAttribute('r',(R+r)/2);
      ring.setAttribute('fill','none'); ring.setAttribute('stroke',color);
      ring.setAttribute('stroke-width', String(R-r));
      const cls = 'series-'+label.replace(/[^a-z0-9]+/gi,'-').toLowerCase();
      ring.setAttribute('data-label', label); ring.classList.add(cls);
      ring.addEventListener('mousemove', e=>showTip(e.clientX,e.clientY, `<b>${label}</b><br>${source==='final'?'Fuente: Final':'Fuente: Detectadas ('+method+')'}<br>Proyectos: ${fmt(pretty(val))}`));
      ring.addEventListener('mouseleave', hideTip);
      svg.appendChild(ring); return;
    }

    pairs.forEach(([label,val],i)=>{
      const frac = total>0 ? val/total : 0;
      const ang1=ang0+frac*2*Math.PI, color=pickColor(i);
      const x0=cx+R*Math.cos(ang0), y0=cy+R*Math.sin(ang0), x1=cx+R*Math.cos(ang1), y1=cy+R*Math.sin(ang1);
      const large=(ang1-ang0)>Math.PI?1:0;
      const path=document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d',`M ${x0} ${y0} A ${R} ${R} 0 ${large} 1 ${x1} ${y1} L ${cx+r*Math.cos(ang1)} ${cy+r*Math.sin(ang1)} A ${r} ${r} 0 ${large} 0 ${cx+r*Math.cos(ang0)} ${cy+r*Math.sin(ang0)} Z`);
      path.setAttribute('fill',color);
      const cls = 'series-'+label.replace(/[^a-z0-9]+/gi,'-').toLowerCase();
      path.setAttribute('data-label', label); path.classList.add(cls);
      path.addEventListener('mousemove', e=>{
        const pct = total>0 ? (val/total*100).toFixed(1) : '0.0';
        showTip(e.clientX,e.clientY, `<b>${label}</b><br>${source==='final'?'Fuente: Final':'Fuente: Detectadas ('+method+')'}<br>Proyectos: ${fmt(pretty(val))} (${pct}%)`);
      });
      path.addEventListener('mouseleave', hideTip);
      svg.appendChild(path); ang0=ang1;
    });
  }

  // Leyenda (simple, interactiva)
  const _legendStates = {};
  function renderLegend(el, pairs, opts={}){
    const chartId = opts.chartId || (el.id || 'legend');
    if(!_legendStates[chartId]) _legendStates[chartId] = new Set();
    const state = _legendStates[chartId];
    el.innerHTML = '';
    pairs.forEach(([k,v],i)=>{
      const label = k || '‚Äî';
      const key = label;
      const color = pickColor(i);
      const item = document.createElement('div'); item.className='item';
      if(state.size && !state.has(key)) item.classList.add('inactive');
      item.innerHTML = `<span class="sw" style="background:${color}"></span><span style="min-width:160px;display:inline-block">${label}</span><b>${fmt(Math.round(v*100)/100)}</b>`;
      item.addEventListener('mouseenter', ()=>{
        document.querySelectorAll('[class^="series-"]').forEach(n=>n.style.opacity='0.15');
        const cls = '.series-'+key.replace(/[^a-z0-9]+/gi,'-').toLowerCase();
        document.querySelectorAll(cls).forEach(n=>n.style.opacity='1');
      });
      item.addEventListener('mouseleave', ()=>{
        document.querySelectorAll('[class^="series-"]').forEach(n=>n.style.opacity='1');
      });
      item.addEventListener('click', ()=>{
        if(state.has(key)) state.delete(key); else state.add(key);
        Array.from(el.children).forEach(ch=>ch.classList.remove('inactive'));
        Array.from(el.children).forEach(ch=>{
          const txt = ch.textContent.trim();
          const lbl = txt.replace(/\s+[\d.,]+$/, '');
          if(state.size && !state.has(lbl)) ch.classList.add('inactive');
        });
        if(typeof opts.onChange === 'function') opts.onChange();
      });
      el.appendChild(item);
    });
  }

  // ------------- DATA + UI -------------
  let RAW=[], VIEW=[];
  let MODE_SOURCE = 'final';      // 'final' | 'detectadas'
  let MODE_WEIGHT = 'bruto';      // 'bruto' | 'ponderado'

  function normalizeKeys(o){
    const keys=['id_empresas','razon_social','ruc','titulo','estado','direccion','departamento','provincia','distrito','actividad_economica','sector_economico','telefono','correo','area_final','tipo_final','areas_detectadas','tipos_detectados'];
    const out={}; keys.forEach(k=> out[k]= o[k] ?? o[k?.toUpperCase?.()] ?? o[k?.toLowerCase?.()] ?? ''); return out;
  }

  function loadData(rows){
    RAW = rows.map(normalizeKeys); VIEW=[...RAW];

    // Filtros globales (sobre FINAL)
    const areas = [''].concat(uniq(RAW.map(d=>(d.area_final||'').toUpperCase())).sort());
    $('#filter-area').innerHTML = areas.map(v=>`<option value="${v}">${v||'Todas las √°reas'}</option>`).join('');

    const tipos = [''].concat(uniq(RAW.map(d=>(d.tipo_final||'').toUpperCase())).sort());
    $('#filter-tiponuevo').innerHTML = tipos.map(v=>`<option value="${v}">${v||'Todos los tipos'}</option>`).join('');

    const deps = uniq(RAW.map(d=>(d.departamento||'').toUpperCase())).sort();
    $('#select-depa').innerHTML = [''].concat(deps).map(v=>`<option value="${v}">${v||'Todos los departamentos'}</option>`).join('');
    if($('#filter-depa')){
      $('#filter-depa').innerHTML = [''].concat(deps).map(v=>`<option value="${v}">${v||'Todos los departamentos'}</option>`).join('');
    }

    refreshAll();
  }

  function applyFilters(){
    const fa = $('#filter-area').value;
    const ft = $('#filter-tiponuevo').value;
    const fd = ($('#filter-depa') ? $('#filter-depa').value : '');
    VIEW = RAW.filter(d=>{
      const okA = !fa || (d.area_final||'').toUpperCase() === fa;
      const okT = !ft || (d.tipo_final||'').toUpperCase() === ft;
      const okD = !fd || (d.departamento||'').toUpperCase() === fd;
      return okA && okT && okD;
    });
  }

  function uniqueDetected(rows, col){
    return uniq(rows.flatMap(d => parseDetected(d[col] || '')));
  }

  function updateKpis(){
    $('#kpi-total').textContent   = fmt(VIEW.length);
    $('#kpi-areas').textContent   = fmt(uniq(VIEW.map(d=>(d.area_final||'').toUpperCase())).length);
    $('#kpi-tipos').textContent   = fmt(uniq(VIEW.map(d=>(d.tipo_final||'').toUpperCase())).length);
    $('#kpi-tel').textContent     = fmt(VIEW.filter(d=> (d.telefono||'').trim()).length);
    $('#kpi-mail').textContent    = fmt(VIEW.filter(d=> (d.correo||'').trim()).length);
    // KPIs detectadas
    $('#kpi-areas-det').textContent = fmt(uniqueDetected(VIEW,'areas_detectadas').length);
    $('#kpi-tipos-det').textContent = fmt(uniqueDetected(VIEW,'tipos_detectados').length);
    // Modo
    $('#kpi-modo').textContent = MODE_SOURCE==='final' ? 'Final' : `Detectadas (${MODE_WEIGHT})`;
  }

  function pairsFromMode(rows, main='tipo'){ // main: 'tipo'|'area'
    if(MODE_SOURCE==='final'){
      if(main==='tipo') return groupCountFinal(rows,'tipo_final');
      if(main==='area') return groupCountFinal(rows,'area_final');
    } else {
      const weighted = (MODE_WEIGHT==='ponderado');
      if(main==='tipo') return countDetected(rows,'tipos_detectados',{weighted});
      if(main==='area') return countDetected(rows,'areas_detectadas',{weighted});
    }
    return [];
  }

  function renderGeneral(){
    // Distribuci√≥n principal (usamos TIPO como default)
    const tipoPairs = pairsFromMode(VIEW,'tipo');
    const srcLabel = MODE_SOURCE==='final' ? 'Usando TIPO_FINAL' : `Usando TIPOS_DETECTADOS (${MODE_WEIGHT})`;
    $('#hint-main').innerHTML = ` ${srcLabel}`;
    renderDonut($('#chart-gen-tipo'), tipoPairs, {source: MODE_SOURCE, method: MODE_WEIGHT});
    renderLegend($('#legend-gen-tipo'), tipoPairs, {chartId: 'gen-tipo', onChange: renderGeneral});

    // Top departamentos (siempre cuenta registros por dpto)
    const depa = groupCountFinal(VIEW,'departamento').slice(0,10);
    renderBarClassic($('#chart-gen-depa'), depa, {maxBars:10});
    renderLegend($('#legend-gen-depa'), depa, {chartId: 'gen-depa', onChange: renderGeneral});
  }

  function renderTable(){
    const tb = $('#table tbody'); if(!tb) return; tb.innerHTML='';
    const q = ($('#search')?.value || '').trim().toLowerCase();
    const data = !q ? VIEW : VIEW.filter(d=>{
      return ['ruc','razon_social','titulo','area_final','tipo_final','departamento','provincia','distrito']
        .some(k => (d[k]||'').toString().toLowerCase().includes(q));
    });
    data.forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${d.id_empresas||''}</td>
        <td>${d.ruc||''}</td>
        <td>${d.razon_social||''}</td>
        <td>${d.titulo||''}</td>
        <td>${d.tipo_final||''}</td>`;
      tr.addEventListener('click',()=>openModal(d));
      tb.appendChild(tr);
    });
  }

  function renderViews(){
    renderGeneral();

    const depaCounts = groupCountFinal(VIEW,'departamento');
    renderHeatmap($('#heatmap'), depaCounts);

    // Distribuci√≥n por Dpto con selector de agrupaci√≥n
    const selDep = $('#select-depa').value || '';
    const grpKey = $('#group-by').value || 'area_final';

    const filtered = selDep ? VIEW.filter(d=> (d.departamento||'').toUpperCase()===selDep) : VIEW;

    let pairs = [];
    if(grpKey==='area_final'){
      $('#hint-dpto').innerHTML = 'Usando <b>√ÅREA_FINAL</b>';
      pairs = groupCountFinal(filtered, 'area_final');
      renderDonut($('#chart-group-dpto'), pairs, {source:'final', method:'bruto'});
    } else if(grpKey==='tipo_final'){
      $('#hint-dpto').innerHTML = 'Usando <b>TIPO_FINAL</b>';
      pairs = groupCountFinal(filtered, 'tipo_final');
      renderDonut($('#chart-group-dpto'), pairs, {source:'final', method:'bruto'});
    } else if(grpKey==='areas_detectadas'){
      $('#hint-dpto').innerHTML = 'Usando <b>√ÅREAS_DETECTADAS</b>';
      pairs = countDetected(filtered, 'areas_detectadas', {weighted: MODE_WEIGHT==='ponderado'});
      renderDonut($('#chart-group-dpto'), pairs, {source:'detectadas', method: MODE_WEIGHT});
    } else if(grpKey==='tipos_detectados'){
      $('#hint-dpto').innerHTML = 'Usando <b>TIPOS_DETECTADOS</b>';
      pairs = countDetected(filtered, 'tipos_detectados', {weighted: MODE_WEIGHT==='ponderado'});
      renderDonut($('#chart-group-dpto'), pairs, {source:'detectadas', method: MODE_WEIGHT});
    }
    renderLegend($('#legend-group-dpto'), pairs, {chartId: 'group-dpto', onChange: renderViews});

    renderTable();
  }

  function refreshAll(){ applyFilters(); updateKpis(); renderViews(); }

  function openModal(d){
    const dep = (d.departamento||'').toString().trim();
    const pro = (d.provincia||'').toString().trim();
    const dis = (d.distrito||'').toString().trim();
    const lugar = [dep, pro, dis].filter(Boolean).join(' / ') || '‚Äî';
    $('#m-ruc').textContent   = d.ruc || '‚Äî';
    $('#m-razon').textContent = d.razon_social || '‚Äî';
    $('#m-lugar').textContent = lugar;
    $('#m-area').textContent  = d.area_final || '‚Äî';
    $('#m-tipo').textContent  = d.tipo_final || '‚Äî';
    $('#m-sector').textContent = d.sector_economico || '‚Äî';
    $('#m-actividad').textContent = d.actividad_economica || '‚Äî';
    $('#m-mail').textContent  = d.correo || '‚Äî';
    $('#m-tel').textContent   = d.telefono || '‚Äî';
    // trazabilidad
    $('#m-areas-det').textContent = d.areas_detectadas || '‚Äî';
    $('#m-tipos-det').textContent = d.tipos_detectados || '‚Äî';
    document.getElementById('modal').showModal();
  }

  // ------------- Eventos -------------
  document.addEventListener('input', e=>{ if(e.target && (e.target.id==='search')) renderTable(); });
  $('#filter-area').addEventListener('change', refreshAll);
  $('#filter-tiponuevo').addEventListener('change', refreshAll);
  if($('#filter-depa')) $('#filter-depa').addEventListener('change', refreshAll);
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      $$('.view').forEach(v=>v.classList.remove('active')); document.getElementById(btn.dataset.view).classList.add('active');
    });
  });
  $('#select-depa').addEventListener('change', renderViews);
  $('#group-by').addEventListener('change', renderViews);

  // Toggle Fuente (Final / Detectadas)
  $$('#toggle-source button').forEach(b=>{
    b.addEventListener('click', ()=>{
      $$('#toggle-source button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      MODE_SOURCE = b.dataset.src; // 'final' | 'detectadas'
      // Mostrar/ocultar m√©todo de conteo
      $('#wrap-weight').style.display = MODE_SOURCE==='detectadas' ? '' : 'none';
      refreshAll();
    });
  });

  // Toggle M√©todo (Bruto / Ponderado)
  $$('#toggle-weight button').forEach(b=>{
    b.addEventListener('click', ()=>{
      $$('#toggle-weight button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      MODE_WEIGHT = b.dataset.w; // 'bruto' | 'ponderado'
      refreshAll();
    });
  });

  // ------------- Carga CSV (sin tocar ruta) -------------
  async function loadPreferExternal(){
    const FILE_NAME = 'data_final.csv';
    try{
      const res = await fetch(FILE_NAME, {cache:'no-store'});
      if(!res.ok) throw new Error('No encontrado');
      const txt = await res.text();
      loadData(parseCSV(txt, ';'));
      console.info('CSV externo cargado:', FILE_NAME);
    }catch(e){
      console.warn('No se pudo leer', FILE_NAME, '-> uso CSV embebido');
      const fallback = document.getElementById('csv-data').textContent.trim();
      if(fallback){ loadData(parseCSV(fallback, ';')); }
      else{ alert('No se encontr√≥ '+FILE_NAME+' ni CSV embebido.'); }
    }
  }
  window.addEventListener('DOMContentLoaded', loadPreferExternal);
  </script>
</body>
</html>
